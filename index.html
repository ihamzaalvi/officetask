<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IVS Task Management</title>
    <style>
        /* Previous CSS remains the same */
        .email-toggle {
            display: flex;
            align-items: center;
            margin: 15px 0;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
            margin: 0 10px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #27ae60;
        }
        input:checked + .slider:before {
            transform: translateX(30px);
        }
    </style>
</head>
<body>
    <!-- Previous HTML remains the same until the Assign Task form -->
    <div id="assign-task" class="tab-content">
        <h2>Assign New Task</h2>
        <form id="taskForm" onsubmit="assignTask(event)">
            <div class="form-group">
                <label for="employee">Assign To:</label>
                <select id="employee" required></select>
            </div>
            <div class="email-toggle">
                <span>Assign via:</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="assignViaEmail">
                    <span class="slider"></span>
                </label>
                <span id="assignMethodText">In-System</span>
            </div>
            <div class="form-group">
                <label for="taskTitle">Task Title:</label>
                <input type="text" id="taskTitle" required>
            </div>
            <div class="form-group">
                <label for="taskDescription">Description:</label>
                <textarea id="taskDescription" required></textarea>
            </div>
            <div class="form-group">
                <label for="dueDate">Due Date:</label>
                <input type="date" id="dueDate" required>
            </div>
            <div class="form-group">
                <label for="priority">Priority:</label>
                <select id="priority" required>
                    <option value="Low">Low</option>
                    <option value="Medium">Medium</option>
                    <option value="High">High</option>
                </select>
            </div>
            <input type="submit" value="Assign Task">
        </form>
    </div>
    <!-- Rest of HTML remains the same -->

    <script>
        // Updated JavaScript for new features

        // Toggle email assignment UI
        document.getElementById('assignViaEmail').addEventListener('change', function() {
            document.getElementById('assignMethodText').textContent = 
                this.checked ? "Email" : "In-System";
        });

        // Modified assignTask function
        function assignTask(event) {
            event.preventDefault();
            
            if (!currentUser || (currentUser.role !== 'owner' && currentUser.role !== 'manager')) return;
            
            const employeeInfo = document.getElementById('employee').value.split('|');
            const employeeName = employeeInfo[0];
            const employeeEmail = employeeInfo[1];
            const title = document.getElementById('taskTitle').value;
            const description = document.getElementById('taskDescription').value;
            const dueDate = document.getElementById('dueDate').value;
            const priority = document.getElementById('priority').value;
            const assignViaEmail = document.getElementById('assignViaEmail').checked;
            
            // Check if assignee is valid
            const assignee = users.find(u => u.email === employeeEmail);
            if (!assignee) {
                alert('Invalid employee selected');
                return;
            }
            
            // Managers can't assign to other managers or owner
            if (currentUser.role === 'manager' && (assignee.role === 'manager' || assignee.role === 'owner')) {
                alert('Managers can only assign tasks to employees');
                return;
            }
            
            // Create task object
            const newTask = {
                id: tasks.length + 1,
                assignedByName: currentUser.name,
                assignedByEmail: currentUser.email,
                employeeName,
                employeeEmail,
                title,
                description,
                dueDate,
                assignedDate: new Date().toISOString().split('T')[0],
                priority,
                status: "Not Completed",
                completionDate: null,
                assignedViaEmail: assignViaEmail
            };
            
            // Add to system if not email-only assignment
            if (!assignViaEmail) {
                tasks.push(newTask);
                updateTaskTable();
                updateMyTasksTable();
            }
            
            // Send email notification
            sendTaskEmail(newTask, assignViaEmail);
            
            // Reset form
            document.getElementById('taskForm').reset();
            document.getElementById('assignViaEmail').checked = false;
            document.getElementById('assignMethodText').textContent = "In-System";
            
            alert(`Task assigned ${assignViaEmail ? 'via Email' : 'in System'} successfully!`);
            if (!assignViaEmail) openTab('tasks');
        }

        // Updated email sending function
        function sendTaskEmail(task, isEmailOnly) {
            const subject = `New Task: ${task.title}`;
            let body = `Dear ${task.employeeName},\n\n`;
            
            if (isEmailOnly) {
                body += `You have been assigned a new task via email by ${task.assignedByName}:\n\n`;
            } else {
                body += `You have been assigned a new task by ${task.assignedByName}:\n\n`;
            }
            
            body += `Title: ${task.title}\n`;
            body += `Description: ${task.description}\n`;
            body += `Due Date: ${formatDate(task.dueDate)}\n`;
            body += `Priority: ${task.priority}\n\n`;
            
            if (!isEmailOnly) {
                body += `Please log in to the task management system to view and update this task.\n\n`;
            } else {
                body += `Please confirm receipt of this task by replying to this email.\n\n`;
            }
            
            body += `Best regards,\n${task.assignedByName}`;
            
            // Simulate sending email (in real app, use an API)
            console.log(`Sending email to ${task.employeeEmail}:\nSubject: ${subject}\nBody: ${body}`);
            
            // Create mailto link for demo
            const mailtoLink = `mailto:${task.employeeEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink, '_blank');
        }

        // Updated populateEmployeeDropdowns to allow owner to assign to managers
        function populateEmployeeDropdowns() {
            const employeeDropdown = document.getElementById('employee');
            
            // Clear dropdown
            employeeDropdown.innerHTML = '<option value="">Select Employee</option>';
            
            // Populate based on current user's role
            users.forEach(user => {
                // Owner can assign to anyone except themselves
                if (currentUser.role === 'owner' && user.email !== currentUser.email) {
                    const option = document.createElement('option');
                    option.value = `${user.name}|${user.email}`;
                    option.textContent = `${user.name} (${user.role})`;
                    employeeDropdown.appendChild(option);
                } 
                // Managers can only assign to employees
                else if (currentUser.role === 'manager' && user.role === 'employee') {
                    const option = document.createElement('option');
                    option.value = `${user.name}|${user.email}`;
                    option.textContent = user.name;
                    employeeDropdown.appendChild(option);
                }
            });
        }

        // Rest of the JavaScript remains the same
    </script>
</body>
</html>
